/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
/*
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
 * FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
 * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
 * IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
 * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */
import { Component, Input } from '@angular/core';
import { BehaviorSubject, merge, timer } from 'rxjs';
import { debounce, distinctUntilChanged, partition, switchMap, tap } from 'rxjs/operators';
import { PendingRequestsInterceptor } from '../services/pending-requests-interceptor.service';
import { SpinnerVisibilityService } from '../services/spinner-visibility.service';
import { Spinkit } from '../spinkits';
var NgHttpLoaderComponent = /** @class */ (function () {
    function NgHttpLoaderComponent(pendingRequestsInterceptor, spinnerVisibility) {
        var _this = this;
        this.pendingRequestsInterceptor = pendingRequestsInterceptor;
        this.spinnerVisibility = spinnerVisibility;
        this.spinkit = Spinkit;
        this._isVisible$ = new BehaviorSubject(false);
        this.visibleUntil = Date.now();
        this.spinner = Spinkit.skWave;
        this.filteredUrlPatterns = [];
        this.filteredMethods = [];
        this.filteredHeaders = [];
        this.debounceDelay = 0;
        this.minDuration = 0;
        this.extraDuration = 0;
        this.entryComponent = null;
        var _a = tslib_1.__read(partition(function (h) { return h; })(this.pendingRequestsInterceptor.pendingRequestsStatus$), 2), showSpinner$ = _a[0], hideSpinner$ = _a[1];
        this.subscriptions = merge(this.pendingRequestsInterceptor.pendingRequestsStatus$.pipe(switchMap(function () { return showSpinner$.pipe(debounce(function () { return timer(_this.debounceDelay); })); })), showSpinner$.pipe(switchMap(function () { return hideSpinner$.pipe(debounce(function () { return _this.getVisibilityTimer$(); })); })), this.spinnerVisibility.visibility$)
            .pipe(distinctUntilChanged(), tap(function (h) { return _this.updateExpirationDelay(h); }))
            .subscribe(function (h) { return _this._isVisible$.next(h); });
    }
    /**
     * @return {?}
     */
    NgHttpLoaderComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        this.nullifySpinnerIfEntryComponentIsDefined();
        this.initFilters();
    };
    /**
     * @return {?}
     */
    NgHttpLoaderComponent.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        this.subscriptions.unsubscribe();
    };
    Object.defineProperty(NgHttpLoaderComponent.prototype, "isVisible$", {
        get: /**
         * @return {?}
         */
        function () {
            return this._isVisible$.asObservable();
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @private
     * @return {?}
     */
    NgHttpLoaderComponent.prototype.nullifySpinnerIfEntryComponentIsDefined = /**
     * @private
     * @return {?}
     */
    function () {
        if (this.entryComponent) {
            this.spinner = null;
        }
    };
    /**
     * @private
     * @return {?}
     */
    NgHttpLoaderComponent.prototype.initFilters = /**
     * @private
     * @return {?}
     */
    function () {
        this.initFilteredUrlPatterns();
        this.initFilteredMethods();
        this.initFilteredHeaders();
    };
    /**
     * @private
     * @return {?}
     */
    NgHttpLoaderComponent.prototype.initFilteredUrlPatterns = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        if (!(this.filteredUrlPatterns instanceof Array)) {
            throw new TypeError('`filteredUrlPatterns` must be an array.');
        }
        if (!!this.filteredUrlPatterns.length) {
            this.filteredUrlPatterns.forEach(function (e) {
                return _this.pendingRequestsInterceptor.filteredUrlPatterns.push(new RegExp(e));
            });
        }
    };
    /**
     * @private
     * @return {?}
     */
    NgHttpLoaderComponent.prototype.initFilteredMethods = /**
     * @private
     * @return {?}
     */
    function () {
        if (!(this.filteredMethods instanceof Array)) {
            throw new TypeError('`filteredMethods` must be an array.');
        }
        this.pendingRequestsInterceptor.filteredMethods = this.filteredMethods;
    };
    /**
     * @private
     * @return {?}
     */
    NgHttpLoaderComponent.prototype.initFilteredHeaders = /**
     * @private
     * @return {?}
     */
    function () {
        if (!(this.filteredHeaders instanceof Array)) {
            throw new TypeError('`filteredHeaders` must be an array.');
        }
        this.pendingRequestsInterceptor.filteredHeaders = this.filteredHeaders;
    };
    /**
     * @private
     * @param {?} showSpinner
     * @return {?}
     */
    NgHttpLoaderComponent.prototype.updateExpirationDelay = /**
     * @private
     * @param {?} showSpinner
     * @return {?}
     */
    function (showSpinner) {
        if (showSpinner) {
            this.visibleUntil = Date.now() + this.minDuration;
        }
    };
    /**
     * @private
     * @return {?}
     */
    NgHttpLoaderComponent.prototype.getVisibilityTimer$ = /**
     * @private
     * @return {?}
     */
    function () {
        return timer(Math.max(this.extraDuration, this.visibleUntil - Date.now()));
    };
    NgHttpLoaderComponent.decorators = [
        { type: Component, args: [{
                    selector: 'ng-http-loader',
                    template: "<div id=\"spinner\" *ngIf=\"isVisible$ | async\">\n\n    <ng-container *ngComponentOutlet=\"entryComponent\"></ng-container>\n\n    <sk-cube-grid\n        *ngIf=\"spinner === spinkit.skCubeGrid\"\n        [backgroundColor]=\"backgroundColor\">\n    </sk-cube-grid>\n\n    <sk-chasing-dots\n        *ngIf=\"spinner === spinkit.skChasingDots\"\n        [backgroundColor]=\"backgroundColor\">\n    </sk-chasing-dots>\n\n    <sk-double-bounce\n        *ngIf=\"spinner === spinkit.skDoubleBounce\"\n        [backgroundColor]=\"backgroundColor\">\n    </sk-double-bounce>\n\n    <sk-rotating-plane\n        *ngIf=\"spinner === spinkit.skRotatingPlane\"\n        [backgroundColor]=\"backgroundColor\">\n    </sk-rotating-plane>\n\n    <sk-spinner-pulse\n        *ngIf=\"spinner === spinkit.skSpinnerPulse\"\n        [backgroundColor]=\"backgroundColor\">\n    </sk-spinner-pulse>\n\n    <sk-three-bounce\n        *ngIf=\"spinner === spinkit.skThreeBounce\"\n        [backgroundColor]=\"backgroundColor\">\n    </sk-three-bounce>\n\n    <sk-wandering-cubes\n        *ngIf=\"spinner === spinkit.skWanderingCubes\"\n        [backgroundColor]=\"backgroundColor\">\n    </sk-wandering-cubes>\n\n    <sk-wave\n        *ngIf=\"spinner === spinkit.skWave\"\n        [backgroundColor]=\"backgroundColor\">\n    </sk-wave>\n\n</div>\n\n",
                    styles: ["#spinner{top:0;left:0;height:100%;width:100%;position:fixed;z-index:9999;display:flex;align-items:center;justify-content:center;opacity:.7;background-color:#f1f1f1}::ng-deep .colored-parent,::ng-deep .colored>div{background-color:#333}"]
                }] }
    ];
    /** @nocollapse */
    NgHttpLoaderComponent.ctorParameters = function () { return [
        { type: PendingRequestsInterceptor },
        { type: SpinnerVisibilityService }
    ]; };
    NgHttpLoaderComponent.propDecorators = {
        backgroundColor: [{ type: Input }],
        spinner: [{ type: Input }],
        filteredUrlPatterns: [{ type: Input }],
        filteredMethods: [{ type: Input }],
        filteredHeaders: [{ type: Input }],
        debounceDelay: [{ type: Input }],
        minDuration: [{ type: Input }],
        extraDuration: [{ type: Input }],
        entryComponent: [{ type: Input }]
    };
    return NgHttpLoaderComponent;
}());
export { NgHttpLoaderComponent };
if (false) {
    /** @type {?} */
    NgHttpLoaderComponent.prototype.spinkit;
    /**
     * @type {?}
     * @private
     */
    NgHttpLoaderComponent.prototype._isVisible$;
    /**
     * @type {?}
     * @private
     */
    NgHttpLoaderComponent.prototype.subscriptions;
    /**
     * @type {?}
     * @private
     */
    NgHttpLoaderComponent.prototype.visibleUntil;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.backgroundColor;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.spinner;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.filteredUrlPatterns;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.filteredMethods;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.filteredHeaders;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.debounceDelay;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.minDuration;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.extraDuration;
    /** @type {?} */
    NgHttpLoaderComponent.prototype.entryComponent;
    /**
     * @type {?}
     * @private
     */
    NgHttpLoaderComponent.prototype.pendingRequestsInterceptor;
    /**
     * @type {?}
     * @private
     */
    NgHttpLoaderComponent.prototype.spinnerVisibility;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctaHR0cC1sb2FkZXIuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmctaHR0cC1sb2FkZXIvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy9uZy1odHRwLWxvYWRlci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQVNBLE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFxQixNQUFNLGVBQWUsQ0FBQztBQUNwRSxPQUFPLEVBQUUsZUFBZSxFQUFFLEtBQUssRUFBNEIsS0FBSyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9FLE9BQU8sRUFBRSxRQUFRLEVBQUUsb0JBQW9CLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzRixPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxrREFBa0QsQ0FBQztBQUM5RixPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSx3Q0FBd0MsQ0FBQztBQUNsRixPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRXRDO0lBOEJJLCtCQUFvQiwwQkFBc0QsRUFBVSxpQkFBMkM7UUFBL0gsaUJBaUJDO1FBakJtQiwrQkFBMEIsR0FBMUIsMEJBQTBCLENBQTRCO1FBQVUsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUEwQjtRQXhCeEgsWUFBTyxHQUFHLE9BQU8sQ0FBQztRQUNqQixnQkFBVyxHQUFHLElBQUksZUFBZSxDQUFVLEtBQUssQ0FBQyxDQUFDO1FBRWxELGlCQUFZLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBSzNCLFlBQU8sR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDO1FBRXpCLHdCQUFtQixHQUFhLEVBQUUsQ0FBQztRQUVuQyxvQkFBZSxHQUFhLEVBQUUsQ0FBQztRQUUvQixvQkFBZSxHQUFhLEVBQUUsQ0FBQztRQUUvQixrQkFBYSxHQUFHLENBQUMsQ0FBQztRQUVsQixnQkFBVyxHQUFHLENBQUMsQ0FBQztRQUVoQixrQkFBYSxHQUFHLENBQUMsQ0FBQztRQUVsQixtQkFBYyxHQUFRLElBQUksQ0FBQztRQUd4QixJQUFBLHFIQUFtSCxFQUFsSCxvQkFBWSxFQUFFLG9CQUFvRztRQUV6SCxJQUFJLENBQUMsYUFBYSxHQUFHLEtBQUssQ0FDdEIsSUFBSSxDQUFDLDBCQUEwQixDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FDdkQsU0FBUyxDQUFDLGNBQU0sT0FBQSxZQUFZLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxjQUFNLE9BQUEsS0FBSyxDQUFDLEtBQUksQ0FBQyxhQUFhLENBQUMsRUFBekIsQ0FBeUIsQ0FBQyxDQUFDLEVBQTVELENBQTRELENBQUMsQ0FDaEYsRUFDRCxZQUFZLENBQUMsSUFBSSxDQUNiLFNBQVMsQ0FBQyxjQUFNLE9BQUEsWUFBWSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsY0FBTSxPQUFBLEtBQUksQ0FBQyxtQkFBbUIsRUFBRSxFQUExQixDQUEwQixDQUFDLENBQUMsRUFBN0QsQ0FBNkQsQ0FBQyxDQUNqRixFQUNELElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxXQUFXLENBQ3JDO2FBQ0ksSUFBSSxDQUNELG9CQUFvQixFQUFFLEVBQ3RCLEdBQUcsQ0FBQyxVQUFBLENBQUMsSUFBSSxPQUFBLEtBQUksQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLENBQUMsRUFBN0IsQ0FBNkIsQ0FBQyxDQUMxQzthQUNBLFNBQVMsQ0FBQyxVQUFBLENBQUMsSUFBSSxPQUFBLEtBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUF4QixDQUF3QixDQUFDLENBQUM7SUFDbEQsQ0FBQzs7OztJQUVELHdDQUFROzs7SUFBUjtRQUNJLElBQUksQ0FBQyx1Q0FBdUMsRUFBRSxDQUFDO1FBQy9DLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUN2QixDQUFDOzs7O0lBRUQsMkNBQVc7OztJQUFYO1FBQ0ksSUFBSSxDQUFDLGFBQWEsQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUNyQyxDQUFDO0lBRUQsc0JBQUksNkNBQVU7Ozs7UUFBZDtZQUNJLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUMzQyxDQUFDOzs7T0FBQTs7Ozs7SUFFTyx1RUFBdUM7Ozs7SUFBL0M7UUFDSSxJQUFJLElBQUksQ0FBQyxjQUFjLEVBQUU7WUFDckIsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7U0FDdkI7SUFDTCxDQUFDOzs7OztJQUVPLDJDQUFXOzs7O0lBQW5CO1FBQ0ksSUFBSSxDQUFDLHVCQUF1QixFQUFFLENBQUM7UUFDL0IsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7UUFDM0IsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7SUFDL0IsQ0FBQzs7Ozs7SUFFTyx1REFBdUI7Ozs7SUFBL0I7UUFBQSxpQkFVQztRQVRHLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxtQkFBbUIsWUFBWSxLQUFLLENBQUMsRUFBRTtZQUM5QyxNQUFNLElBQUksU0FBUyxDQUFDLHlDQUF5QyxDQUFDLENBQUM7U0FDbEU7UUFFRCxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsTUFBTSxFQUFFO1lBQ25DLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxPQUFPLENBQUMsVUFBQSxDQUFDO2dCQUM5QixPQUFBLEtBQUksQ0FBQywwQkFBMEIsQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFBdkUsQ0FBdUUsQ0FDMUUsQ0FBQztTQUNMO0lBQ0wsQ0FBQzs7Ozs7SUFFTyxtREFBbUI7Ozs7SUFBM0I7UUFDSSxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsZUFBZSxZQUFZLEtBQUssQ0FBQyxFQUFFO1lBQzFDLE1BQU0sSUFBSSxTQUFTLENBQUMscUNBQXFDLENBQUMsQ0FBQztTQUM5RDtRQUNELElBQUksQ0FBQywwQkFBMEIsQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQztJQUMzRSxDQUFDOzs7OztJQUVPLG1EQUFtQjs7OztJQUEzQjtRQUNJLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxlQUFlLFlBQVksS0FBSyxDQUFDLEVBQUU7WUFDMUMsTUFBTSxJQUFJLFNBQVMsQ0FBQyxxQ0FBcUMsQ0FBQyxDQUFDO1NBQzlEO1FBQ0QsSUFBSSxDQUFDLDBCQUEwQixDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDO0lBQzNFLENBQUM7Ozs7OztJQUVPLHFEQUFxQjs7Ozs7SUFBN0IsVUFBOEIsV0FBb0I7UUFDOUMsSUFBSSxXQUFXLEVBQUU7WUFDYixJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDO1NBQ3JEO0lBQ0wsQ0FBQzs7Ozs7SUFFTyxtREFBbUI7Ozs7SUFBM0I7UUFDSSxPQUFPLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQy9FLENBQUM7O2dCQTVHSixTQUFTLFNBQUM7b0JBQ1AsUUFBUSxFQUFFLGdCQUFnQjtvQkFDMUIsbXpDQUE4Qzs7aUJBRWpEOzs7O2dCQVJRLDBCQUEwQjtnQkFDMUIsd0JBQXdCOzs7a0NBYzVCLEtBQUs7MEJBRUwsS0FBSztzQ0FFTCxLQUFLO2tDQUVMLEtBQUs7a0NBRUwsS0FBSztnQ0FFTCxLQUFLOzhCQUVMLEtBQUs7Z0NBRUwsS0FBSztpQ0FFTCxLQUFLOztJQWtGViw0QkFBQztDQUFBLEFBN0dELElBNkdDO1NBeEdZLHFCQUFxQjs7O0lBQzlCLHdDQUF5Qjs7Ozs7SUFDekIsNENBQTBEOzs7OztJQUMxRCw4Q0FBb0M7Ozs7O0lBQ3BDLDZDQUFrQzs7SUFFbEMsZ0RBQytCOztJQUMvQix3Q0FDZ0M7O0lBQ2hDLG9EQUMwQzs7SUFDMUMsZ0RBQ3NDOztJQUN0QyxnREFDc0M7O0lBQ3RDLDhDQUN5Qjs7SUFDekIsNENBQ3VCOztJQUN2Qiw4Q0FDeUI7O0lBQ3pCLCtDQUNrQzs7Ozs7SUFFdEIsMkRBQThEOzs7OztJQUFFLGtEQUFtRCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SXG4gKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTU1xuICogRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SXG4gKiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVJcbiAqIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOXG4gKiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLlxuICovXG5cbmltcG9ydCB7IENvbXBvbmVudCwgSW5wdXQsIE9uRGVzdHJveSwgT25Jbml0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIG1lcmdlLCBPYnNlcnZhYmxlLCBTdWJzY3JpcHRpb24sIHRpbWVyIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBkZWJvdW5jZSwgZGlzdGluY3RVbnRpbENoYW5nZWQsIHBhcnRpdGlvbiwgc3dpdGNoTWFwLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBQZW5kaW5nUmVxdWVzdHNJbnRlcmNlcHRvciB9IGZyb20gJy4uL3NlcnZpY2VzL3BlbmRpbmctcmVxdWVzdHMtaW50ZXJjZXB0b3Iuc2VydmljZSc7XG5pbXBvcnQgeyBTcGlubmVyVmlzaWJpbGl0eVNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9zcGlubmVyLXZpc2liaWxpdHkuc2VydmljZSc7XG5pbXBvcnQgeyBTcGlua2l0IH0gZnJvbSAnLi4vc3BpbmtpdHMnO1xuXG5AQ29tcG9uZW50KHtcbiAgICBzZWxlY3RvcjogJ25nLWh0dHAtbG9hZGVyJyxcbiAgICB0ZW1wbGF0ZVVybDogJy4vbmctaHR0cC1sb2FkZXIuY29tcG9uZW50Lmh0bWwnLFxuICAgIHN0eWxlVXJsczogWycuL25nLWh0dHAtbG9hZGVyLmNvbXBvbmVudC5zY3NzJ11cbn0pXG5leHBvcnQgY2xhc3MgTmdIdHRwTG9hZGVyQ29tcG9uZW50IGltcGxlbWVudHMgT25EZXN0cm95LCBPbkluaXQge1xuICAgIHB1YmxpYyBzcGlua2l0ID0gU3BpbmtpdDtcbiAgICBwcml2YXRlIF9pc1Zpc2libGUkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxib29sZWFuPihmYWxzZSk7XG4gICAgcHJpdmF0ZSBzdWJzY3JpcHRpb25zOiBTdWJzY3JpcHRpb247XG4gICAgcHJpdmF0ZSB2aXNpYmxlVW50aWwgPSBEYXRlLm5vdygpO1xuXG4gICAgQElucHV0KClcbiAgICBwdWJsaWMgYmFja2dyb3VuZENvbG9yOiBzdHJpbmc7XG4gICAgQElucHV0KClcbiAgICBwdWJsaWMgc3Bpbm5lciA9IFNwaW5raXQuc2tXYXZlO1xuICAgIEBJbnB1dCgpXG4gICAgcHVibGljIGZpbHRlcmVkVXJsUGF0dGVybnM6IHN0cmluZ1tdID0gW107XG4gICAgQElucHV0KClcbiAgICBwdWJsaWMgZmlsdGVyZWRNZXRob2RzOiBzdHJpbmdbXSA9IFtdO1xuICAgIEBJbnB1dCgpXG4gICAgcHVibGljIGZpbHRlcmVkSGVhZGVyczogc3RyaW5nW10gPSBbXTtcbiAgICBASW5wdXQoKVxuICAgIHB1YmxpYyBkZWJvdW5jZURlbGF5ID0gMDtcbiAgICBASW5wdXQoKVxuICAgIHB1YmxpYyBtaW5EdXJhdGlvbiA9IDA7XG4gICAgQElucHV0KClcbiAgICBwdWJsaWMgZXh0cmFEdXJhdGlvbiA9IDA7XG4gICAgQElucHV0KClcbiAgICBwdWJsaWMgZW50cnlDb21wb25lbnQ6IGFueSA9IG51bGw7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHBlbmRpbmdSZXF1ZXN0c0ludGVyY2VwdG9yOiBQZW5kaW5nUmVxdWVzdHNJbnRlcmNlcHRvciwgcHJpdmF0ZSBzcGlubmVyVmlzaWJpbGl0eTogU3Bpbm5lclZpc2liaWxpdHlTZXJ2aWNlKSB7XG4gICAgICAgIGNvbnN0IFtzaG93U3Bpbm5lciQsIGhpZGVTcGlubmVyJF0gPSBwYXJ0aXRpb24oKGg6IGJvb2xlYW4pID0+IGgpKHRoaXMucGVuZGluZ1JlcXVlc3RzSW50ZXJjZXB0b3IucGVuZGluZ1JlcXVlc3RzU3RhdHVzJCk7XG5cbiAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25zID0gbWVyZ2UoXG4gICAgICAgICAgICB0aGlzLnBlbmRpbmdSZXF1ZXN0c0ludGVyY2VwdG9yLnBlbmRpbmdSZXF1ZXN0c1N0YXR1cyQucGlwZShcbiAgICAgICAgICAgICAgICBzd2l0Y2hNYXAoKCkgPT4gc2hvd1NwaW5uZXIkLnBpcGUoZGVib3VuY2UoKCkgPT4gdGltZXIodGhpcy5kZWJvdW5jZURlbGF5KSkpKVxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIHNob3dTcGlubmVyJC5waXBlKFxuICAgICAgICAgICAgICAgIHN3aXRjaE1hcCgoKSA9PiBoaWRlU3Bpbm5lciQucGlwZShkZWJvdW5jZSgoKSA9PiB0aGlzLmdldFZpc2liaWxpdHlUaW1lciQoKSkpKVxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIHRoaXMuc3Bpbm5lclZpc2liaWxpdHkudmlzaWJpbGl0eSQsXG4gICAgICAgIClcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKCksXG4gICAgICAgICAgICAgICAgdGFwKGggPT4gdGhpcy51cGRhdGVFeHBpcmF0aW9uRGVsYXkoaCkpXG4gICAgICAgICAgICApXG4gICAgICAgICAgICAuc3Vic2NyaWJlKGggPT4gdGhpcy5faXNWaXNpYmxlJC5uZXh0KGgpKTtcbiAgICB9XG5cbiAgICBuZ09uSW5pdCgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5udWxsaWZ5U3Bpbm5lcklmRW50cnlDb21wb25lbnRJc0RlZmluZWQoKTtcbiAgICAgICAgdGhpcy5pbml0RmlsdGVycygpO1xuICAgIH1cblxuICAgIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgICAgICB0aGlzLnN1YnNjcmlwdGlvbnMudW5zdWJzY3JpYmUoKTtcbiAgICB9XG5cbiAgICBnZXQgaXNWaXNpYmxlJCgpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2lzVmlzaWJsZSQuYXNPYnNlcnZhYmxlKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBudWxsaWZ5U3Bpbm5lcklmRW50cnlDb21wb25lbnRJc0RlZmluZWQoKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLmVudHJ5Q29tcG9uZW50KSB7XG4gICAgICAgICAgICB0aGlzLnNwaW5uZXIgPSBudWxsO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpbml0RmlsdGVycygpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5pbml0RmlsdGVyZWRVcmxQYXR0ZXJucygpO1xuICAgICAgICB0aGlzLmluaXRGaWx0ZXJlZE1ldGhvZHMoKTtcbiAgICAgICAgdGhpcy5pbml0RmlsdGVyZWRIZWFkZXJzKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpbml0RmlsdGVyZWRVcmxQYXR0ZXJucygpOiB2b2lkIHtcbiAgICAgICAgaWYgKCEodGhpcy5maWx0ZXJlZFVybFBhdHRlcm5zIGluc3RhbmNlb2YgQXJyYXkpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdgZmlsdGVyZWRVcmxQYXR0ZXJuc2AgbXVzdCBiZSBhbiBhcnJheS4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghIXRoaXMuZmlsdGVyZWRVcmxQYXR0ZXJucy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHRoaXMuZmlsdGVyZWRVcmxQYXR0ZXJucy5mb3JFYWNoKGUgPT5cbiAgICAgICAgICAgICAgICB0aGlzLnBlbmRpbmdSZXF1ZXN0c0ludGVyY2VwdG9yLmZpbHRlcmVkVXJsUGF0dGVybnMucHVzaChuZXcgUmVnRXhwKGUpKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgaW5pdEZpbHRlcmVkTWV0aG9kcygpOiB2b2lkIHtcbiAgICAgICAgaWYgKCEodGhpcy5maWx0ZXJlZE1ldGhvZHMgaW5zdGFuY2VvZiBBcnJheSkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ2BmaWx0ZXJlZE1ldGhvZHNgIG11c3QgYmUgYW4gYXJyYXkuJyk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5wZW5kaW5nUmVxdWVzdHNJbnRlcmNlcHRvci5maWx0ZXJlZE1ldGhvZHMgPSB0aGlzLmZpbHRlcmVkTWV0aG9kcztcbiAgICB9XG5cbiAgICBwcml2YXRlIGluaXRGaWx0ZXJlZEhlYWRlcnMoKTogdm9pZCB7XG4gICAgICAgIGlmICghKHRoaXMuZmlsdGVyZWRIZWFkZXJzIGluc3RhbmNlb2YgQXJyYXkpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdgZmlsdGVyZWRIZWFkZXJzYCBtdXN0IGJlIGFuIGFycmF5LicpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMucGVuZGluZ1JlcXVlc3RzSW50ZXJjZXB0b3IuZmlsdGVyZWRIZWFkZXJzID0gdGhpcy5maWx0ZXJlZEhlYWRlcnM7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB1cGRhdGVFeHBpcmF0aW9uRGVsYXkoc2hvd1NwaW5uZXI6IGJvb2xlYW4pOiB2b2lkIHtcbiAgICAgICAgaWYgKHNob3dTcGlubmVyKSB7XG4gICAgICAgICAgICB0aGlzLnZpc2libGVVbnRpbCA9IERhdGUubm93KCkgKyB0aGlzLm1pbkR1cmF0aW9uO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRWaXNpYmlsaXR5VGltZXIkKCk6IE9ic2VydmFibGU8bnVtYmVyPiB7XG4gICAgICAgIHJldHVybiB0aW1lcihNYXRoLm1heCh0aGlzLmV4dHJhRHVyYXRpb24sIHRoaXMudmlzaWJsZVVudGlsIC0gRGF0ZS5ub3coKSkpO1xuICAgIH1cbn1cbiJdfQ==